<!-- client-dashboard.component.html -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <button class="btn btn-outline-light" routerLink="">←</button>
    <span class="navbar-brand mx-auto fw-semibold">My Bookings</span>
  </div>
</nav>
<div class="dashboard-container" *ngIf="!isLoading">
  <!-- Stats Cards -->
  <div class="stats-section">
    <div class="container">
      <div class="stats-grid">

        <div class="stat-card">
          <div class="stat-icon upcoming">
            <i class="bi bi-calendar-check"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ upcomingTrips }}</div>
            <div class="stat-label">Upcoming Trips</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon completed">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ completedTrips }}</div>
            <div class="stat-label">Completed</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon total">
            <i class="bi bi-grid"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ totalBookings }}</div>
            <div class="stat-label">Total Bookings</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon spent">
            <i class="bi bi-currency-rupee"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">₹{{ totalSpent | number:'1.0-0' }}</div>
            <div class="stat-label">Total Spent</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <div class="container">
      <div class="tabs-wrapper">
        <button class="tab-button" [class.active]="activeTab === 'upcoming'" (click)="switchTab('upcoming')">
          <i class="bi bi-calendar-check me-2"></i>
          Upcoming
          <span class="tab-badge" *ngIf="upcomingBookings.length > 0">
            {{ upcomingBookings.length }}
          </span>
        </button>

        <button class="tab-button" [class.active]="activeTab === 'past'" (click)="switchTab('past')">
          <i class="bi bi-clock-history me-2"></i>
          Past
          <span class="tab-badge" *ngIf="pastBookings.length > 0">
            {{ pastBookings.length }}
          </span>
        </button>

        <button class="tab-button" [class.active]="activeTab === 'cancelled'" (click)="switchTab('cancelled')">
          <i class="bi bi-x-circle me-2"></i>
          Cancelled
          <span class="tab-badge" *ngIf="cancelledBookings.length > 0">
            {{ cancelledBookings.length }}
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="errorMessage && !isLoading" class="d-flex justify-content-center loader-wrapper" style="min-height: 80vh">
    <div class="text-center">
      <img src="../../assets/assets/Bus vehicle.gif" width="180" alt="Loading" />
      <p class="mt-3 text-muted text-center">{{ errorMessage }}</p>
      <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadBookings()">
        Retry
      </button>
    </div>
  </div>

  <!-- Bookings List -->
  <div class="bookings-section" *ngIf="!isLoading && !errorMessage">
    <div class="container">

      <!-- Booking Cards -->
      <div class="booking-card" *ngFor="let booking of currentBookings">

        <!-- Card Header with Image -->
        <div class="booking-header">
          <img [src]="'http://localhost:4001/' + booking.cover_image" [alt]="booking.trek_name" class="trek-image"
            onerror="this.src='assets/default-trek.jpg'" />
          <div class="booking-header-overlay">
            <div class="booking-reference">
              {{ booking.booking_reference }}
            </div>
            <div class="booking-badges">
              <span class="badge" [ngClass]="getStatusClass(booking.booking_status)">
                {{ booking.booking_status | titlecase }}
              </span>
              <span class="badge" [ngClass]="getPaymentStatusClass(booking.payment_status)">
                {{ booking.payment_status | titlecase }}
              </span>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="booking-body">

          <!-- Trek Info -->
          <div class="trek-info">
            <h3 class="trek-name">{{ booking.trek_name }}</h3>
            <p class="trek-location">
              <i class="bi bi-geo-alt-fill me-1"></i>
              {{ booking.location }}
            </p>
          </div>

          <!-- Date & Participants -->
          <div class="booking-details">
            <div class="detail-row">
              <div class="detail-item">
                <i class="bi bi-calendar3 text-primary"></i>
                <div class="detail-content">
                  <span class="detail-label">Trek Dates</span>
                  <span class="detail-value">
                    {{ formatDate(booking.start_date) }} - {{ formatDate(booking.end_date) }}
                  </span>
                </div>
              </div>

              <div class="detail-item">
                <i class="bi bi-people-fill text-success"></i>
                <div class="detail-content">
                  <span class="detail-label">Participants</span>
                  <span class="detail-value">{{ booking.participants }}</span>
                </div>
              </div>
            </div>

            <div class="detail-row">
              <div class="detail-item">
                <i class="bi bi-calendar-plus text-info"></i>
                <div class="detail-content">
                  <span class="detail-label">Booked On</span>
                  <span class="detail-value">{{ formatDate(booking.created_at) }}</span>
                </div>
              </div>

              <div class="detail-item" *ngIf="activeTab === 'upcoming'">
                <i class="bi bi-hourglass-split text-warning"></i>
                <div class="detail-content">
                  <span class="detail-label">Days Until Trek</span>
                  <span class="detail-value">{{ getDaysUntilTrek(booking.start_date) }} days</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Info -->
          <div class="payment-info">
            <div class="payment-row">
              <span class="payment-label">Total Amount:</span>
              <span class="payment-value">₹{{ booking.total_amount | number:'1.0-0' }}</span>
            </div>
            <div class="payment-row">
              <span class="payment-label">Paid:</span>
              <span class="payment-value text-success">₹{{ booking.amount_paid | number:'1.0-0' }}</span>
            </div>
            <div class="payment-row" *ngIf="booking.balance_due > 0">
              <span class="payment-label">Balance Due:</span>
              <span class="payment-value text-danger">₹{{ booking.balance_due | number:'1.0-0' }}</span>
            </div>
          </div>

          <!-- Add-ons -->
          <div class="addons-section" *ngIf="booking.addons && booking.addons.length > 0">
            <div class="addons-label">
              <i class="bi bi-plus-circle me-1"></i>
              Add-ons:
            </div>
            <div class="addons-list">
              <span class="addon-tag" *ngFor="let addon of booking.addons">
                {{ addon.addon_name }} ({{ addon.quantity }})
              </span>
            </div>
          </div>

          <!-- Cancellation Warning -->
          <div class="cancellation-warning" *ngIf="activeTab === 'upcoming' && canCancel(booking)">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
              <strong>Cancellation Policy:</strong>
              {{ getCancellationFeeMessage(booking) }}
            </div>
          </div>

        </div>

        <!-- Card Actions -->
        <div class="booking-actions">
          <button *ngIf="activeTab === 'upcoming'" class="btn btn-outline-primary" (click)="viewBookingDetails(booking)">
            <i class="bi bi-eye me-2"></i>
            View Details
          </button>

          <button *ngIf="activeTab === 'upcoming'" class="btn btn-outline-success" (click)="downloadReceipt(booking)">
            <i class="bi bi-download me-2"></i>
            Receipt
          </button>

          <button *ngIf="activeTab === 'upcoming' && canCancel(booking)" class="btn btn-outline-danger"
            (click)="openCancelModal(booking)">
            <i class="bi bi-x-circle me-2"></i>
            Cancel
          </button>

          <button *ngIf="booking.balance_due > 0 && activeTab === 'upcoming'" class="btn btn-primary">
            <i class="bi bi-credit-card me-2"></i>
            Pay Balance
          </button>
        </div>

      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="currentBookings.length === 0">
        <div class="empty-icon">
          <i class="bi bi-inbox"></i>
        </div>
        <h3>No {{ activeTab }} bookings</h3>
        <p *ngIf="activeTab === 'upcoming'">
          Start planning your next adventure!
        </p>
        <p *ngIf="activeTab === 'past'">
          You haven't completed any treks yet.
        </p>
        <p *ngIf="activeTab === 'cancelled'">
          You don't have any cancelled bookings.
        </p>
        <a routerLink="/upcomingtours" class="btn btn-primary mt-3">
          <i class="bi bi-search me-2"></i>
          Browse Treks
        </a>
      </div>
    </div>
  </div>
</div>