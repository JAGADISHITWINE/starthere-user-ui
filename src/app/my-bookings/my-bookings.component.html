<div class="page">

  <!-- NAV -->
  <nav class="nav">
    <a class="nav-back" routerLink="">‚Üê Back</a>
    <div class="nav-title">My Bookings</div>
  </nav>

  <!-- HERO HEADER -->
  <div class="hero-header">
    <div class="hero-greeting">Welcome back</div>
    <h1 class="hero-title">Your Adventures</h1>

    <div class="stats-strip" *ngIf="!isLoading">
      <div class="stat-cell">
        <div class="stat-tag"><span class="stat-dot dot-blue"></span>Upcoming</div>
        <div class="stat-val">{{ upcomingTrips }}</div>
      </div>
      <div class="stat-cell">
        <div class="stat-tag"><span class="stat-dot dot-emerald"></span>Completed</div>
        <div class="stat-val">{{ completedTrips }}</div>
      </div>
      <div class="stat-cell">
        <div class="stat-tag"><span class="stat-dot dot-violet"></span>Total Bookings</div>
        <div class="stat-val">{{ totalBookings }}</div>
      </div>
      <div class="stat-cell">
        <div class="stat-tag"><span class="stat-dot dot-amber"></span>Total Spent</div>
        <div class="stat-val">‚Çπ{{ totalSpent | number:'1.0-0' }}</div>
      </div>
    </div>
  </div>

  <!-- BODY -->
  <div class="body-wrap" *ngIf="!isLoading">

    <!-- SIDEBAR TABS -->
    <aside class="sidebar">
      <div class="sidebar-label">Filter</div>

      <button class="tab-item" [class.active]="activeTab === 'upcoming'" (click)="switchTab('upcoming')">
        <div class="tab-left">
          <div class="tab-icon">üóì</div>
          <span class="tab-name">Upcoming</span>
        </div>
        <span class="tab-count" *ngIf="upcomingBookings.length">{{ upcomingBookings.length }}</span>
      </button>

      <button class="tab-item" [class.active]="activeTab === 'past'" (click)="switchTab('past')">
        <div class="tab-left">
          <div class="tab-icon">‚úÖ</div>
          <span class="tab-name">Past</span>
        </div>
        <span class="tab-count" *ngIf="pastBookings.length">{{ pastBookings.length }}</span>
      </button>

      <button class="tab-item" [class.active]="activeTab === 'cancelled'" (click)="switchTab('cancelled')">
        <div class="tab-left">
          <div class="tab-icon">‚úï</div>
          <span class="tab-name">Cancelled</span>
        </div>
        <span class="tab-count" *ngIf="cancelledBookings.length">{{ cancelledBookings.length }}</span>
      </button>
    </aside>

    <!-- MAIN -->
    <main class="main-content">

      <!-- ERROR -->
      <div class="error-state" *ngIf="errorMessage">
        <p>{{ errorMessage }}</p>
        <button class="retry-btn" (click)="loadBookings()">Retry</button>
      </div>

      <ng-container *ngIf="!errorMessage">

        <div class="section-head">
          <h2>{{ activeTab | titlecase }} Trips</h2>
          <span class="count">{{ currentBookings.length }} bookings</span>
        </div>

        <!-- BOOKING CARDS -->
        <div class="booking-card" *ngFor="let booking of currentBookings">

          <div class="card-image-strip">
            <img [src]="'http://localhost:4001/' + booking.cover_image"
              [alt]="booking.trek_name"
              onerror="this.src='assets/default-trek.jpg'" />
            <div class="image-overlay">
              <div class="booking-ref">{{ booking.booking_reference }}</div>
              <div class="badge-stack">
                <span class="status-badge" [ngClass]="getStatusClass(booking.booking_status)">
                  {{ booking.booking_status | titlecase }}
                </span>
                <span class="status-badge" [ngClass]="getPaymentStatusClass(booking.payment_status)">
                  {{ booking.payment_status | titlecase }}
                </span>
              </div>
            </div>
          </div>

          <div class="card-body">
            <div class="trek-name">{{ booking.trek_name }}</div>
            <div class="trek-location">üìç {{ booking.location }}</div>
            <div class="user-rating-chip" *ngIf="hasUserRated(booking)">
              Your rating: {{ booking.user_rating }} / 5
            </div>

            <div class="info-grid">
              <div class="info-cell">
                <div class="info-label">Trek Dates</div>
                <div class="info-val">{{ formatDate(booking.start_date) }} ‚Äì {{ formatDate(booking.end_date) }}</div>
              </div>
              <div class="info-cell">
                <div class="info-label">Participants</div>
                <div class="info-val">{{ booking.participants }} people</div>
              </div>
              <div class="info-cell" *ngIf="activeTab === 'upcoming'; else bookedOn">
                <div class="info-label">Days Until Trek</div>
                <div class="countdown-val">{{ getDaysUntilTrek(booking.start_date) }} days</div>
              </div>
              <ng-template #bookedOn>
                <div class="info-cell">
                  <div class="info-label">Booked On</div>
                  <div class="info-val">{{ formatDate(booking.created_at) }}</div>
                </div>
              </ng-template>
            </div>

            <div class="payment-strip">
              <div class="pay-cell">
                <div class="pay-label">Total Amount</div>
                <div class="pay-amount">‚Çπ{{ booking.total_amount | number:'1.0-0' }}</div>
              </div>
              <div class="pay-cell">
                <div class="pay-label">Paid</div>
                <div class="pay-amount positive">‚Çπ{{ booking.amount_paid | number:'1.0-0' }}</div>
              </div>
              <div class="pay-cell" *ngIf="booking.balance_due > 0">
                <div class="pay-label">Balance Due</div>
                <div class="pay-amount danger">‚Çπ{{ booking.balance_due | number:'1.0-0' }}</div>
              </div>
            </div>

            <div class="addons-row" *ngIf="booking.addons?.length">
              <span class="addon-chip" *ngFor="let addon of booking.addons">
                {{ addon.addon_name }} √ó {{ addon.quantity }}
              </span>
            </div>

            <div class="warn-bar" *ngIf="activeTab === 'upcoming' && canCancel(booking)">
              <span class="warn-icon">‚ö†</span>
              <div><strong>Cancellation policy:</strong> {{ getCancellationFeeMessage(booking) }}</div>
            </div>
          </div>

          <div class="card-actions">
            <button class="action-btn" *ngIf="activeTab === 'upcoming'" (click)="viewBookingDetails(booking)">
              üëÅ View Details
            </button>
            <button class="action-btn" *ngIf="activeTab === 'upcoming'" (click)="downloadReceipt(booking)">
              ‚Üì Receipt
            </button>
            <button class="action-btn danger" *ngIf="activeTab === 'upcoming' && canCancel(booking)" (click)="openCancelModal(booking)">
              ‚úï Cancel
            </button>
            <button class="action-btn primary pay-btn" *ngIf="booking.balance_due > 0 && activeTab === 'upcoming'">
              üí≥ Pay Balance
            </button>
            <button
              class="action-btn"
              *ngIf="activeTab === 'past' && booking.booking_status === 'completed'"
              (click)="openRatingModal(booking)"
            >
              ‚≠ê {{ hasUserRated(booking) ? 'Update Rating' : 'Rate Trek' }}
            </button>
          </div>

        </div>

        <!-- EMPTY STATE -->
        <div class="empty-state" *ngIf="currentBookings.length === 0">
          <div class="empty-glyph">?</div>
          <h3>No {{ activeTab }} bookings</h3>
          <p *ngIf="activeTab === 'upcoming'">Start planning your next adventure!</p>
          <p *ngIf="activeTab === 'past'">You haven't completed any treks yet.</p>
          <p *ngIf="activeTab === 'cancelled'">No cancelled bookings.</p>
          <a routerLink="/upcomingtours" class="browse-btn">Browse Treks ‚Üí</a>
        </div>

      </ng-container>
    </main>
  </div>

  <!-- LOADER -->
  <div class="error-state" *ngIf="isLoading" style="min-height:80vh">
    <p>Loading your adventures‚Ä¶</p>
  </div>

  <div class="rating-backdrop" *ngIf="ratingModalOpen" (click)="closeRatingModal()"></div>
  <div class="rating-modal" *ngIf="ratingModalOpen" role="dialog" aria-modal="true">
    <div class="rating-card" (click)="$event.stopPropagation()">
      <h3>Rate Your Trek</h3>
      <p class="rating-subtitle">{{ selectedBookingForRating?.trek_name }}</p>

      <div class="stars-row">
        <button
          type="button"
          class="star-btn"
          *ngFor="let star of [1,2,3,4,5]"
          [class.active]="star <= selectedRating"
          (click)="setRating(star)"
        >
          ‚òÖ
        </button>
      </div>

      <textarea
        class="review-input"
        rows="4"
        maxlength="500"
        placeholder="Share your experience (optional)"
        [(ngModel)]="selectedReview"
      ></textarea>

      <p class="rating-error" *ngIf="ratingErrorMessage">{{ ratingErrorMessage }}</p>

      <div class="rating-actions">
        <button type="button" class="action-btn" (click)="closeRatingModal()">Cancel</button>
        <button type="button" class="action-btn primary" [disabled]="isSubmittingRating" (click)="submitRating()">
          {{ isSubmittingRating ? 'Submitting...' : 'Submit Rating' }}
        </button>
      </div>
    </div>
  </div>

</div>
