<div class="checkout-shell">

  <!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <aside class="left-panel" *ngIf="trek">

    <div class="trek-thumb" style="position:relative">
      <div class="panel-nav">
        <a class="back-btn" [routerLink]="['/tour-details', trekId]">‚Üê Trek Details</a>
      </div>
      <img [src]="'http://localhost:4001/' + trek.cover_image" [alt]="trek.name" />
    </div>

    <div class="trek-info">
      <div class="trek-label">You're booking</div>
      <div class="trek-name">{{ trek.name }}</div>
      <div class="trek-location">üìç {{ trek.location }}</div>
    </div>

    <div class="panel-divider"></div>

    <!-- Vertical stepper -->
    <div class="stepper">
      <div class="step-row" [class.completed]="currentStep > 1" [class.active]="currentStep === 1">
        <div class="step-node">{{ currentStep > 1 ? '‚úì' : '1' }}</div>
        <div class="step-text">
          <div class="step-title">Batch &amp; Dates</div>
          <div class="step-sub" *ngIf="selectedBatch">
            {{ selectedBatch.startDate | date:'MMM dd' }} ¬∑ {{ booking.participants }} participant{{
            booking.participants !== 1 ? 's' : '' }}
          </div>
          <div class="step-sub" *ngIf="!selectedBatch">Choose departure date</div>
        </div>
      </div>

      <div class="step-row" [class.completed]="currentStep > 2" [class.active]="currentStep === 2">
        <div class="step-node">{{ currentStep > 2 ? '‚úì' : '2' }}</div>
        <div class="step-text">
          <div class="step-title">Contact Info</div>
          <div class="step-sub" *ngIf="currentStep > 2">{{ booking.name }}</div>
          <div class="step-sub" *ngIf="currentStep <= 2">Primary contact details</div>
        </div>
      </div>

      <div class="step-row" [class.completed]="currentStep > 3" [class.active]="currentStep === 3">
        <div class="step-node">{{ currentStep > 3 ? '‚úì' : '3' }}</div>
        <div class="step-text">
          <div class="step-title">Participants</div>
          <div class="step-sub">Details for all trekkers</div>
        </div>
      </div>

      <div class="step-row" [class.active]="currentStep === 4">
        <div class="step-node">4</div>
        <div class="step-text">
          <div class="step-title">Review &amp; Pay</div>
          <div class="step-sub">Confirm your booking</div>
        </div>
      </div>
    </div>

    <!-- Live price summary -->
    <div class="price-summary" *ngIf="selectedBatch">
      <div class="price-row">
        <span class="price-label">Trek ({{ booking.participants }} √ó ‚Çπ{{ selectedBatch.price }})</span>
        <span class="price-amt">‚Çπ{{ basePrice | number:'1.0-0' }}</span>
      </div>
      <ng-container *ngFor="let addon of addOns">
        <div class="price-row" *ngIf="addon.selected">
          <span class="price-label">{{ addon.name }} √ó {{ booking.participants }}</span>
          <span class="price-amt">‚Çπ{{ addon.price * booking.participants | number:'1.0-0' }}</span>
        </div>
      </ng-container>
      <div class="price-row total">
        <span class="price-label">Total</span>
        <span class="price-amt">‚Çπ{{ totalPrice | number:'1.0-0' }}</span>
      </div>
    </div>

  </aside>

  <!-- ‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="right-panel">

    <!-- Mobile nav -->
    <div class="mobile-nav">
      <a class="mobile-back" [routerLink]="['/tour-details', trekId]">‚Üê Back</a>
      <div class="mobile-title">Book Your Trek</div>
      <div style="width:60px"></div>
    </div>

    <!-- Mobile steps strip -->
    <div class="mobile-steps">
      <div class="mob-step" [class.completed]="currentStep > 1" [class.active]="currentStep === 1">
        <div class="mob-num">{{ currentStep > 1 ? '‚úì' : '1' }}</div>Batch
      </div>
      <div class="mob-step" [class.completed]="currentStep > 2" [class.active]="currentStep === 2">
        <div class="mob-num">{{ currentStep > 2 ? '‚úì' : '2' }}</div>Contact
      </div>
      <div class="mob-step" [class.completed]="currentStep > 3" [class.active]="currentStep === 3">
        <div class="mob-num">{{ currentStep > 3 ? '‚úì' : '3' }}</div>Participants
      </div>
      <div class="mob-step" [class.active]="currentStep === 4">
        <div class="mob-num">4</div>Review
      </div>
    </div>

    <!-- Alerts -->
    <div class="form-area" style="padding-bottom:0; padding-top:20px" *ngIf="successMessage || errorMessage">
      <div class="success-bar" *ngIf="successMessage">
        ‚úì {{ successMessage }}
        <button class="alert-close" (click)="successMessage = ''">‚úï</button>
      </div>
      <div class="error-bar" *ngIf="errorMessage">
        ‚ö† {{ errorMessage }}
        <button class="alert-close" (click)="errorMessage = ''">‚úï</button>
      </div>
    </div>

    <!-- LOADER -->
    <div class="loader-overlay" *ngIf="isLoading">
      <div class="loader-ring"></div>
      <div class="loader-text">Loading trek details‚Ä¶</div>
    </div>

    <!-- FORM AREA -->
    <div class="form-area" *ngIf="!isLoading">

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <ng-container *ngIf="currentStep === 1">
        <div class="step-headline">
          <div class="step-eyebrow">Step 1 of 4</div>
          <h1 class="step-h1">Select Your Batch</h1>
          <p class="step-desc">Choose a departure date and set your group size.</p>
        </div>

        <div style="margin-bottom:28px">
          <label
            style="font-size:0.75rem;font-weight:700;letter-spacing:0.04em;color:var(--body);display:block;margin-bottom:10px">
            Available Batches <span class="req">*</span>
          </label>
          <div class="batch-options">
            <label class="batch-option" *ngFor="let batch of batches"
              [class.selected]="booking.batchId == batch.batchId"
              [class.disabled]="batch.status !== 'active' || batch.availableSlots === 0">
              <input type="radio" name="batch" [value]="batch.batchId" [(ngModel)]="booking.batchId"
                (change)="onBatchSelect(batch.batchId)"
                [disabled]="batch.status !== 'active' || batch.availableSlots === 0" checked/>
              <div class="batch-radio">
                <div *ngIf="booking.batchId == batch.batchId"
                  style="width:8px;height:8px;border-radius:50%;background:#3d6b4a"></div>
              </div>
              <div class="batch-info">
                <div class="batch-dates">{{ batch.startDate | date:'MMM dd' }} ‚Äì {{ batch.endDate | date:'MMM dd, yyyy'
                  }}</div>
                <div class="batch-meta">{{ batch.duration }} ¬∑ {{ batch.availableSlots }} slots remaining</div>
              </div>
              <div class="batch-price">‚Çπ{{ batch.price }}</div>
              <span class="batch-status" [class.status-ok]="batch.availableSlots > 5"
                [class.status-few]="batch.availableSlots > 0 && batch.availableSlots <= 5"
                [class.status-full]="batch.availableSlots === 0">
                {{ batch.availableSlots === 0 ? 'Full' : batch.availableSlots <= 5 ? 'Few Left' : 'Open' }} </span>
            </label>
          </div>
        </div>

        <div class="form-row" *ngIf="selectedBatch">
          <div class="field">
            <label>Participants <span class="req">*</span></label>
            <div class="counter-row">
              <button class="counter-btn" (click)="decrementParticipants()" type="button">‚àí</button>
              <div class="counter-val">{{ booking.participants }}</div>
              <button class="counter-btn" (click)="incrementParticipants()" type="button">+</button>
            </div>
            <div class="field-hint">Max {{ selectedBatch.availableSlots }} available in this batch</div>
          </div>
          <div class="field">
            <label>Price per Person</label>
            <input class="form-input" [value]="'‚Çπ' + selectedBatch.price" readonly />
          </div>
        </div>

        <div
          style="margin-top:8px;margin-bottom:12px;font-size:0.75rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted)"
          *ngIf="addOns.length">
          Add-ons (Optional)
        </div>
        <div class="addons-grid">
          <label class="addon-card" *ngFor="let addon of addOns" [class.checked]="addon.selected">
            <input type="checkbox" [(ngModel)]="addon.selected" />
            <div class="addon-top">
              <div class="addon-name">{{ addon.name }}</div>
              <div class="addon-check">{{ addon.selected ? '‚úì' : '' }}</div>
            </div>
            <div class="addon-price">‚Çπ{{ addon.price }} / person</div>
          </label>
        </div>
      </ng-container>

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <ng-container *ngIf="currentStep === 2">
        <div class="step-headline">
          <div class="step-eyebrow">Step 2 of 4</div>
          <h1 class="step-h1">Contact Information</h1>
          <p class="step-desc">This person will be the main point of contact for the booking.</p>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Full Name <span class="req">*</span></label>
            <input class="form-input" [(ngModel)]="booking.name" placeholder="Enter full name" />
          </div>
          <div class="field">
            <label>Email <span class="req">*</span></label>
            <input class="form-input" type="email" [(ngModel)]="booking.email" placeholder="your@email.com" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Phone <span class="req">*</span></label>
            <input class="form-input" type="tel" [(ngModel)]="booking.phone" placeholder="+91 XXXXX XXXXX"
              minlength="10" maxlength="10" onlyNumber />
          </div>
          <div class="field">
            <label>Emergency Contact <span class="req">*</span></label>
            <input class="form-input" type="tel" [(ngModel)]="booking.emergencyContact" placeholder="+91 XXXXX XXXXX"
              minlength="10" maxlength="10" onlyNumber />
          </div>
        </div>

        <div class="form-row full">
          <div class="field">
            <label>Special Requests / Medical Info</label>
            <textarea class="form-textarea" [(ngModel)]="booking.specialRequests"
              placeholder="Any allergies, dietary restrictions, or special requirements‚Ä¶"></textarea>
          </div>
        </div>
      </ng-container>

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <ng-container *ngIf="currentStep === 3">
        <div class="step-headline">
          <div class="step-eyebrow">Step 3 of 4</div>
          <h1 class="step-h1">Participant Details</h1>
          <p class="step-desc">Please provide details for all {{ booking.participants }} participant(s).</p>
        </div>

        <div class="info-bar" *ngIf="!areAllParticipantsValid()">
          ‚ö† Please fill all required fields for every participant before continuing.
        </div>

        <div class="participant-block" *ngFor="let participant of participants; let i = index">
          <div class="participant-header">
            <div class="p-num">{{ i + 1 }}</div>
            <div class="p-name">Participant {{ i + 1 }}</div>
            <span class="p-badge" *ngIf="i === 0">Primary Contact</span>
          </div>
          <div class="participant-fields">
            <div class="field">
              <label>Full Name <span class="req">*</span></label>
              <input class="form-input" [(ngModel)]="participant.name" placeholder="Enter full name"
                [disabled]="i === 0" />
              <div class="field-hint" *ngIf="i === 0">Auto-filled from contact info</div>
            </div>
            <div class="field">
              <label>Age <span class="req">*</span></label>
              <input class="form-input" type="number" [(ngModel)]="participant.age" placeholder="e.g. 28"
                (input)="validateAge(participant)" min="18" max="100" />
              <div class="error" *ngIf="participant.ageError">{{ participant.ageError }}</div>
            </div>
            <div class="field">
              <label>Gender <span class="req">*</span></label>
              <select class="form-select" [(ngModel)]="participant.gender">
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="field">
              <label>ID Proof Type <span class="req">*</span></label>
              <select class="form-select" [(ngModel)]="participant.idType"
                (change)="participant.idNumber=''; validateId(participant)">
                <option value="">Select ID</option>
                <option value="Aadhar">Aadhar Card</option>
                <option value="PAN">PAN Card</option>
                <option value="Passport">Passport</option>
                <option value="Driving License">Driving License</option>
                <option value="Voter ID">Voter ID</option>
              </select>
            </div>
            <div class="field">
              <label>ID Number <span class="req">*</span></label>
              <input class="form-input" [(ngModel)]="participant.idNumber"
                [maxlength]="getIdMaxLength(participant.idType)" (input)="formatIdInput(participant)"
                placeholder="Enter ID number" />
              <div class="error" *ngIf="participant.idError">{{ participant.idError }}</div>
            </div>
            <div class="field">
              <label>Phone</label>
              <input class="form-input" type="tel" [(ngModel)]="participant.phone" placeholder="+91 XXXXX XXXXX"
                [disabled]="i === 0" />
              <div class="field-hint" *ngIf="i === 0">Auto-filled from contact info</div>
            </div>
            <div class="field full">
              <label>Medical Conditions / Allergies</label>
              <textarea class="form-textarea" [(ngModel)]="participant.medicalInfo"
                placeholder="Any conditions, allergies, or medications‚Ä¶"></textarea>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ STEP 4 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <ng-container *ngIf="currentStep === 4">
        <div class="step-headline">
          <div class="step-eyebrow">Step 4 of 4</div>
          <h1 class="step-h1">Review Your Booking</h1>
          <p class="step-desc">Please verify all details before proceeding to payment.</p>
        </div>

        <div class="review-block">
          <div class="review-header">
            <div class="review-header-title">Trek Details</div>
            <a class="edit-link" (click)="currentStep = 1">Edit</a>
          </div>
          <div class="review-body">
            <div class="review-row"><span class="review-key">Trek</span><span class="review-val">{{ trek.name }}</span>
            </div>
            <div class="review-row"><span class="review-key">Dates</span><span class="review-val">{{
                selectedBatch?.startDate | date:'MMM dd' }} ‚Äì {{ selectedBatch?.endDate | date:'MMM dd, yyyy' }}</span>
            </div>
            <div class="review-row"><span class="review-key">Duration</span><span class="review-val">{{
                selectedBatch?.duration }}</span></div>
            <div class="review-row"><span class="review-key">Participants</span><span class="review-val">{{
                booking.participants }}</span></div>
          </div>
        </div>

        <div class="review-block">
          <div class="review-header">
            <div class="review-header-title">Primary Contact</div>
            <a class="edit-link" (click)="currentStep = 2">Edit</a>
          </div>
          <div class="review-body">
            <div class="review-row"><span class="review-key">Name</span><span class="review-val">{{ booking.name
                }}</span></div>
            <div class="review-row"><span class="review-key">Email</span><span class="review-val">{{ booking.email
                }}</span></div>
            <div class="review-row"><span class="review-key">Phone</span><span class="review-val">{{ booking.phone
                }}</span></div>
            <div class="review-row"><span class="review-key">Emergency</span><span class="review-val">{{
                booking.emergencyContact }}</span></div>
          </div>
        </div>

        <div class="review-block">
          <div class="review-header">
            <div class="review-header-title">Participants</div>
            <a class="edit-link" (click)="currentStep = 3">Edit</a>
          </div>
          <table class="p-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>ID Type</th>
                <th>ID Number</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of participants; let i = index">
                <td>{{ i + 1 }}</td>
                <td>{{ p.name }}<span class="primary-tag" *ngIf="i === 0">Primary</span></td>
                <td>{{ p.age }}</td>
                <td>{{ p.gender }}</td>
                <td>{{ p.idType }}</td>
                <td>{{ p.idNumber }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="price-breakdown">
          <div class="pb-row">
            <span class="pb-label">Trek ({{ booking.participants }} √ó ‚Çπ{{ selectedBatch?.price }})</span>
            <span class="pb-val">‚Çπ{{ basePrice | number:'1.0-0' }}</span>
          </div>
          <ng-container *ngFor="let addon of addOns">
            <div class="pb-row" *ngIf="addon.selected">
              <span class="pb-label">{{ addon.name }} ({{ booking.participants }} √ó ‚Çπ{{ addon.price }})</span>
              <span class="pb-val">‚Çπ{{ addon.price * booking.participants | number:'1.0-0' }}</span>
            </div>
          </ng-container>
          <div class="pb-row total">
            <span class="pb-label">Total Amount</span>
            <span class="pb-val">‚Çπ{{ totalPrice | number:'1.0-0' }}</span>
          </div>
        </div>

        <label class="terms-check">
          <input type="checkbox" [(ngModel)]="termsAccepted" />
          <div class="terms-text">
            I agree to the <a routerLink="/terms">Terms &amp; Conditions</a> and
            <a routerLink="/cancellation">Cancellation Policy</a> of Karnataka Adventures.
          </div>
        </label>
      </ng-container>

    </div>
    <!-- /form-area -->

    <!-- Bottom bar -->
    <div class="bottom-bar w-100">
      <button class="btn-back" *ngIf="currentStep > 1" (click)="prevStep()">‚Üê Back</button>

      <div class="bar-price" *ngIf="selectedBatch">
        <div class="bar-price-label">Total</div>
        <div class="bar-price-amount">‚Çπ{{ totalPrice | number:'1.0-0' }}</div>
      </div>

      <button class="btn-next" *ngIf="currentStep < 4" (click)="nextStep()" [disabled]="!canProceedToNextStep()">
        Continue ‚Üí
      </button>

      <button class="btn-next btn-pay" *ngIf="currentStep === 4" [disabled]="isSubmitting || !termsAccepted"
        (click)="proceedToPayment()">
        {{ isSubmitting ? 'Processing‚Ä¶' : 'üí≥ Pay Now' }}
      </button>
    </div>

  </div>
  <!-- /right-panel -->

</div>